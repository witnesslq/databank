------------------------
-- 在 boss 库执行
-- 分配Schema DATABANK下所有表的读写权限给 EMP 用户
------------------------

-- 1.角色正向权限表
CREATE TABLE DATABANK.TBL_ROLE_ALLOW
(
	ROLE_ID BIGINT       NOT NULL,
	DS_ID   BIGINT       NOT NULL,
	ALLOW   VARCHAR(200) NOT NULL
);
CREATE INDEX DATABANK."DS_ID_ROLE_ID_index" ON DATABANK.TBL_ROLE_ALLOW (DS_ID, ROLE_ID);


-- 2.加字段, 原表字段不够用
ALTER TABLE DATABANK.TBL_ROLE_NOTALLOW ALTER NOT_ALLOW SET DATA TYPE VARCHAR (200);
ALTER TABLE DATABANK.TBL_ROLE_NOTALLOW ADD DS_ID BIGINT;
DROP INDEX DATABANK."ROLE_NOTALLOW_ID_index";
CREATE INDEX DATABANK."ROLE_ID_DS_ID_index" ON DATABANK.TBL_ROLE_NOTALLOW (ROLE_ID, DS_ID);
CALL SYSPROC.ADMIN_CMD('REORG TABLE DATABANK.TBL_ROLE_NOTALLOW');


-- 3.加索引
CREATE UNIQUE INDEX DATABANK."ROLE_NAME_index" ON DATABANK.TBL_DB_ROLE (ROLE_NAME);
CREATE INDEX DATABANK."LOG_EXECUTOR_index" ON DATABANK.TBL_DB_LOG (LOG_EXECUTOR);
CREATE INDEX DATABANK."LOG_DS_ID_index" ON DATABANK.TBL_DB_LOG (LOG_DS_ID);
CREATE UNIQUE INDEX DATABANK."DS_NAME_index" ON DATABANK.TBL_DB_DATASOURCE (DS_NAME);
CREATE INDEX DATABANK."NOTE_DS_ID_index" ON DATABANK.TBL_DB_NOTE (NOTE_DS_ID);
CREATE INDEX DATABANK."USER_ID_index" ON DATABANK.TBL_DB_USER_NOTE (USER_ID);
CREATE INDEX DATABANK."USER_NOTE_USER_ID_index" ON DATABANK.TBL_DB_USER_ROLE (USER_ID);


-- 4.角色-数据源关系
CREATE TABLE DATABANK.TBL_ROLE_DATASOURCE
(
	ROLE_ID BIGINT NOT NULL,
	DS_ID   BIGINT NOT NULL
);
CREATE INDEX DATABANK."ROLE_ID_index" ON DATABANK.TBL_ROLE_DATASOURCE (ROLE_ID);
CREATE INDEX DATABANK."DS_ID_index" ON DATABANK.TBL_ROLE_DATASOURCE (DS_ID);


-- 5.统计数据
-- CREATE TABLE DATABANK.TBL_STAT_DS
-- (
-- 	ID      BIGINT PRIMARY KEY
-- 	GENERATED BY DEFAULT AS IDENTITY,
-- 	DATESTR DATE   NOT NULL,
-- 	DS_ID   BIGINT NOT NULL,
-- 	NUM     INT DEFAULT 0
-- );
-- CREATE INDEX DATABANK."STAT_DS_DS_ID_index" ON DATABANK.TBL_STAT_DS (DS_ID);


CREATE TABLE DATABANK.TBL_STAT_USER
(
	ID         BIGINT PRIMARY KEY
	GENERATED BY DEFAULT AS IDENTITY,
	DATESTR    DATE        NOT NULL,
	LOGIN_NAME VARCHAR(40) NOT NULL,
	NUM        INT DEFAULT 0,
	AVG_SCORE      INT DEFAULT 0,
	SUM_TIME   INT DEFAULT 0,
	AVG_TIME   INT DEFAULT 0
);
CREATE UNIQUE INDEX DATABANK."LOGIN_NAME_DATESTR_index" ON DATABANK.TBL_STAT_USER(LOGIN_NAME,DATESTR);


-- 6.功能、菜单
INSERT INTO EMP.TBL_FUNCTION (FUNCTIONID, FUNCTIONNAME, FUNCTIONURL, PREFUNCTIONID, FUNCTIONSTATUS, DESCRIPTION, RISKLEVEL, FUNCTIONTYPE, CREATETIME, CHECKFUNCTIONID, CHECKNEEDED, LOGNEEDED) VALUES (-330040, '[数据银行]统计数据', 'https://boss3g.yeepay.com/databank-boss/stat/list.action', -99910033, 'ACTIVE', '查看各种统计数据', 'MIDDLE', 'DEPARTMENT_PRIVATE', CURRENT_TIMESTAMP, null, null, null);
INSERT INTO EMP.TBL_FUNCTION (FUNCTIONID, FUNCTIONNAME, FUNCTIONURL, PREFUNCTIONID, FUNCTIONSTATUS, DESCRIPTION, RISKLEVEL, FUNCTIONTYPE, CREATETIME, CHECKFUNCTIONID, CHECKNEEDED, LOGNEEDED) VALUES (-330041, '[数据银行]手工更新统计数据', 'https://boss3g.yeepay.com/databank-boss/stat/update.action', -99910033, 'ACTIVE', '手工更新统计数据', 'MIDDLE', 'DEPARTMENT_PRIVATE', CURRENT_TIMESTAMP, null, null, null);
INSERT INTO EMP.TBL_ROLEANDFUNCTIONRELATION (ROLEID, FUNCTIONID) values (152,-330040);
INSERT INTO EMP.TBL_ROLEANDFUNCTIONRELATION (ROLEID, FUNCTIONID) values (152,-330041);

-- 部门功能关系表
INSERT INTO EMP.TBL_DEPARTMENTANDFUNCTIONRELATION (DEPARTMENTID, FUNCTIONID) values
(-2,-330040),
(-2,-330041);

INSERT INTO EMP.TBL_MENU (MENUID, MENUNAME, FUNCTIONID, SEQUENCE, PARENTID, LEVELNUM, ICONNAME) VALUES
(-330009, '统计分析', -330040, 10, -3301, 3, null);


-- 7.统计辅助表
CREATE TABLE DATABANK.TBL_DATE
(
	DATESTR VARCHAR(10) NOT NULL
);
CREATE UNIQUE INDEX "DATE_STR_index" ON DATABANK.TBL_DATE ( DATESTR );


insert into DATABANK.TBL_DATE
	SELECT
		datestr
	FROM
		(SELECT
			 date('2013-08-01') + (row_NUMBER()
			                       OVER () - 1) days AS datestr
FROM SYSIBM.syscoldist )
WHERE datestr < DATE ('2014-08-01');